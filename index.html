<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimNation - Active Lots and Players</title>
    <style>
        /* Base styles for the dashboard */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin-bottom: 20px;
        }
        #main-container {
            display: flex;
            justify-content: space-between;
            width: 90%;
        }
        .container {
            width: 45%;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .scrollable {
            max-height: 300px;
            overflow-y: scroll;
        }
        .hidden {
            display: none;
        }
        #tempoSim {
            margin-bottom: 20px;
        }
    </style>
    <script>
        // Function to fetch data using AllOrigins
        async function fetchWithAllOrigins(url) {
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return JSON.parse(data.contents);
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        // Function to load city data and map lot IDs to names
        async function loadCityData() {
            const cityData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/city/1/city.json');
            if (!cityData) {
                console.error('Failed to load city data');
                return null;
            }

            const lotMapping = {};
            for (let i = 0; i < cityData.reservedLots.length; i++) {
                lotMapping[cityData.reservedLots[i]] = cityData.names[i];
            }

            return lotMapping;
        }

        // Function to load and display online players
        async function loadOnlinePlayers() {
            const onlineData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/avatars/online');
            if (!onlineData || !onlineData.avatars) {
                console.error('Failed to load online players');
                document.getElementById('players').innerHTML = 'Error loading online players.';
                return;
            }

            const lotMapping = await loadCityData();
            if (!lotMapping) {
                document.getElementById('players').innerHTML = 'Error loading lot names.';
                return;
            }

            document.getElementById('players-title').textContent = `Sims Online: ${onlineData.avatars_online_count}`;
            const playersContainer = document.getElementById('players');
            playersContainer.innerHTML = ''; // Clear previous content

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Sim</th>
                            <th class="hidden">ID</th>
                            <th class="hidden">Location ID</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>`;

            onlineData.avatars.forEach(avatar => {
                const lotName = lotMapping[avatar.location] || 'Unknown';
                tableHtml += `
                    <tr>
                        <td>${avatar.name}</td>
                        <td class="hidden">${avatar.avatar_id}</td>
                        <td class="hidden">${avatar.location}</td>
                        <td>${lotName}</td>
                    </tr>`;
            });

            tableHtml += `
                    </tbody>
                </table>`;

            playersContainer.innerHTML = tableHtml;
        }

        // Function to load and display active lots
        async function loadLots() {
            try {
                const cityData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/city/1/city.json');
                if (!cityData) {
                    document.getElementById('lots').innerHTML = 'Error loading lots.';
                    return;
                }

                const activeLots = cityData.activeLots;
                const onlineCounts = cityData.onlineCount;
                const lotMapping = {};
                for (let i = 0; i < cityData.reservedLots.length; i++) {
                    lotMapping[cityData.reservedLots[i]] = cityData.names[i];
                }

                const lotsContainer = document.getElementById('lots');
                lotsContainer.innerHTML = ''; // Clear previous content

                let lotsData = activeLots.map((lotID, index) => {
                    return {
                        name: lotMapping[lotID] || lotID,
                        count: onlineCounts[index]
                    };
                });

                lotsData.sort((a, b) => b.count - a.count);

                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Sims Inside</th>
                            </tr>
                        </thead>
                        <tbody>`;

                lotsData.forEach(lot => {
                    if (lot.count > 0) {
                        tableHtml += `
                            <tr>
                                <td>${lot.name}</td>
                                <td>${lot.count}</td>
                            </tr>`;
                    }
                });

                tableHtml += `
                        </tbody>
                    </table>`;

                lotsContainer.innerHTML = tableHtml;

            } catch (error) {
                console.error('Error loading lots:', error);
                document.getElementById('lots').innerHTML = 'Error loading lots.';
            }
        }

        // Function to handle in-game time (tempoSim)
        function tempoSim() {
            const timeElement = document.getElementById('tempoSim');
            let startTime = new Date().getTime();

            setInterval(() => {
                let currentTime = new Date().getTime();
                let inGameTime = ((currentTime - startTime) / 1000).toFixed(0); // Simulate time progression
                timeElement.innerHTML = `Sim Time: ${inGameTime} seconds`;
            }, 1000);
        }

        // Function to fetch and display rewards
        async function fetchRewards() {
            try {
                const response = await fetchWithAllOrigins('http://simnationserver.com/redeem/');
                if (!response) {
                    document.getElementById('rewards').classList.add('hidden');
                    console.error('Error fetching rewards.');
                    return;
                }
                populateRewards(response);
            } catch (error) {
                console.error('Failed to fetch rewards:', error);
            }
        }

        // Function to populate the rewards dropdown
        function populateRewards(htmlContent) {
            const rewardsDropdown = document.getElementById('rewards-dropdown');
            rewardsDropdown.innerHTML = htmlContent;
            document.getElementById('rewards').classList.remove('hidden');
        }

        // Function to load all data on window load
        window.onload = function() {
            loadLots();
            tempoSim();
            fetchRewards();
            loadOnlinePlayers();
        };
    </script>
</head>
<body>
    <h1>SimNation Dashboard</h1>
    <div id="tempoSim">Loading time...</div>
    <div id="main-container">
        <div class="container">
            <h3 id="players-title">Sims Online: COUNT</h3>
            <div id="players" class="scrollable"></div> <!-- Players Container -->
        </div>
        <div class="container">
            <h3 id="lots-title">Active Lots</h3>
            <div id="lots" class="scrollable"></div> <!-- Lots Container -->
        </div>
    </div>
    <div id="rewards" class="hidden">
        <h3>Available Rewards</h3>
        <div id="rewards-dropdown"></div>
    </div>
</body>
</html>
