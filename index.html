<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimNation - Active Lots and Players</title>
    <style>
        /* Existing styles unchanged */
    </style>
    <script>
        async function fetchWithAllOrigins(url) {
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return JSON.parse(data.contents);
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        async function loadCityData() {
            const cityData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/city/1/city.json');
            if (!cityData) {
                console.error('Failed to load city data');
                return null;
            }

            // Create a mapping of lot IDs to names
            const lotMapping = {};
            for (let i = 0; i < cityData.reservedLots.length; i++) {
                lotMapping[cityData.reservedLots[i]] = cityData.names[i];
            }

            return lotMapping;
        }

        async function loadOnlinePlayers() {
            const onlineData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/avatars/online');
            if (!onlineData || !onlineData.avatars) {
                console.error('Failed to load online players');
                document.getElementById('players').innerHTML = 'Error loading online players.';
                return;
            }

            // Load lot names from city data
            const lotMapping = await loadCityData();
            if (!lotMapping) {
                document.getElementById('players').innerHTML = 'Error loading lot names.';
                return;
            }

            // Update the title with the count of online players
            document.getElementById('players-title').textContent = `Sims Online: ${onlineData.avatars_online_count}`;

            const playersContainer = document.getElementById('players');
            playersContainer.innerHTML = ''; // Clear previous content

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Sim</th>
                            <th class="hidden">ID</th>
                            <th class="hidden">Location ID</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>`;

            // Use the lotMapping to get the lot name based on the location ID
            onlineData.avatars.forEach(avatar => {
                const lotName = lotMapping[avatar.location] || 'Unknown'; // Fallback to 'Unknown' if lot name not found
                tableHtml += `
                    <tr>
                        <td>${avatar.name}</td>
                        <td class="hidden">${avatar.avatar_id}</td>
                        <td class="hidden">${avatar.location}</td>
                        <td>${lotName}</td>
                    </tr>`;
            });

            tableHtml += `
                    </tbody>
                </table>`;

            playersContainer.innerHTML = tableHtml; // Update the container with the table
        }

        async function loadLots() {
            try {
                const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('http://simnation.ddns.net:9000/userapi/city/1/city.json'));
                const data = await response.json();
                const jsonData = JSON.parse(data.contents);

                const activeLots = jsonData.activeLots;
                const onlineCounts = jsonData.onlineCount;
                const lotMapping = {};
                for (let i = 0; i < jsonData.reservedLots.length; i++) {
                    lotMapping[jsonData.reservedLots[i]] = jsonData.names[i];
                }

                const lotsContainer = document.getElementById('lots');
                lotsContainer.innerHTML = ''; // Clear previous content

                let lotsData = activeLots.map((lotID, index) => {
                    return {
                        name: lotMapping[lotID] || lotID, // Fallback to ID if name not found
                        count: onlineCounts[index]
                    };
                });

                // Sort lots by Sims count (busiest first)
                lotsData.sort((a, b) => b.count - a.count);

                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Sims Inside</th>
                            </tr>
                        </thead>
                        <tbody>`;

                lotsData.forEach(lot => {
                    if (lot.count > 0) {
                        tableHtml += `
                            <tr>
                                <td>${lot.name}</td>
                                <td>${lot.count}</td>
                            </tr>`;
                    }
                });

                tableHtml += `
                        </tbody>
                    </table>`;

                lotsContainer.innerHTML = tableHtml;

            } catch (error) {
                console.error('Error loading lots:', error);
                document.getElementById('lots').innerHTML = 'Error loading lots.';
            }
        }

        function tempoSim() {
            // Existing time function unchanged
        }

        async function fetchRewards() {
            // Existing rewards fetching logic unchanged
        }

        function populateRewards(htmlContent) {
            // Existing rewards population logic unchanged
        }

        window.onload = function() {
            loadLots();
            tempoSim(); // Start the in-game time function
            fetchRewards(); // Fetch rewards on load
            loadOnlinePlayers(); // Load online players
        };
    </script>
</head>
<body>
    <h1>SimNation Dashboard</h1>
    <div id="tempoSim">Loading time...</div>
    <div id="main-container">
        <div class="container">
            <h3 id="players-title">Sims Online: COUNT</h3>
            <div id="players" class="scrollable"></div> <!-- Players Container -->
        </div>
        <div class="container">
            <h3 id="lots-title">Active Lots</h3>
            <div id="lots" class="scrollable"></div> <!-- Lots Container -->
        </div>
    </div>
    <div id="rewards" class="hidden">
        <h3>Available Rewards</h3>
        <div id="rewards-dropdown"></div>
    </div>
</body>
</html>
