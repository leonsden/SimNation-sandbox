<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimNation Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #players {
            margin-top: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        /* Hide columns for ID and Location ID */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <h1>SimNation Dashboard</h1>
    <div id="players">
        <h2>Online Players</h2>
        <p>Loading online players...</p>
    </div>

    <script>
        async function fetchWithAllOrigins(url) {
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return JSON.parse(data.contents);
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        async function loadLotName(lotId) {
            if (lotId === 0) return 'Unknown'; // Return 'Unknown' for lot ID 0
            const lotData = await fetchWithAllOrigins(`http://simnationserver.com:9000/userapi/city/1/i${lotId}.json`);
            return lotData ? lotData.name : 'N/A'; // Return the lot name if valid
        }

        async function loadOnlinePlayers() {
            const onlineData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/avatars/online');
            if (!onlineData || !onlineData.avatars) {
                console.error('Failed to load online players');
                document.getElementById('players').innerHTML = 'Error loading online players.';
                return;
            }

            const playersContainer = document.getElementById('players');
            playersContainer.innerHTML = ''; // Clear previous content

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Sim</th>
                            <th class="hidden">ID</th>
                            <th class="hidden">Location ID</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>`;

            // Fetch each player's lot name based on their location ID
            const playerPromises = onlineData.avatars.map(async (avatar) => {
                const lotName = await loadLotName(avatar.location); // Fetch lot name using the location ID
                return {
                    name: avatar.name,
                    id: avatar.avatar_id,
                    location: avatar.location,
                    lotName: lotName // Include lot name in the object
                };
            });

            // Wait for all promises to resolve
            const players = await Promise.all(playerPromises);

            // Sort players alphabetically by name
            players.sort((a, b) => a.name.localeCompare(b.name));

            players.forEach(player => {
                tableHtml += `
                    <tr>
                        <td>${player.name}</td>
                        <td class="hidden">${player.id}</td>
                        <td class="hidden">${player.location}</td>
                        <td>${player.lotName}</td>
                    </tr>`;
            });

            tableHtml += `
                    </tbody>
                </table>`;

            playersContainer.innerHTML = tableHtml; // Update the container with the table
        }

        window.onload = function() {
            loadOnlinePlayers();
        };
    </script>

</body>
</html>
