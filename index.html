<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimNation Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #players {
            margin-top: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <h1>SimNation Dashboard</h1>
    <div id="players">
        <h2>Online Players</h2>
        <p>Loading online players...</p>
    </div>

    <script>
        // Function to calculate player age in days based on the custom in-game epoch
        function calculatePlayerAge(gameTimestamp) {
            const currentTimestamp = Math.floor(Date.now() / 1000); // Current time in seconds
            const epochAdjustment = 1728072236 - 3 * 24 * 60 * 60; // Known example: this timestamp corresponds to 3 days

            // Adjust the timestamp based on the inferred custom epoch
            const adjustedTimestamp = gameTimestamp - epochAdjustment;
            const ageInSeconds = currentTimestamp - adjustedTimestamp;
            const ageInDays = Math.floor(ageInSeconds / (60 * 60 * 24)); // Convert seconds to days

            return ageInDays >= 0 ? ageInDays : 'N/A'; // Ensure no negative values
        }

        async function fetchWithAllOrigins(url) {
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return JSON.parse(data.contents);
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        async function loadPlayerAge(id) {
            const playerData = await fetchWithAllOrigins(`http://simnationserver.com:9000/userapi/avatars/${id}`);
            return playerData && playerData.date ? playerData.date : null; // Check if date exists and return it
        }

        async function loadOnlinePlayers() {
            const onlineData = await fetchWithAllOrigins('http://simnation.ddns.net:9000/userapi/avatars/online');
            if (!onlineData || !onlineData.avatars) {
                console.error('Failed to load online players');
                document.getElementById('players').innerHTML = 'Error loading online players.';
                return;
            }

            const playersContainer = document.getElementById('players');
            playersContainer.innerHTML = ''; // Clear previous content

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>ID</th>
                            <th>Age (Days)</th>
                        </tr>
                    </thead>
                    <tbody>`;

            // Fetch each player's age based on their ID
            const playerPromises = onlineData.avatars.map(async (avatar) => {
                const ageTimestamp = await loadPlayerAge(avatar.avatar_id);
                return {
                    name: avatar.name,
                    id: avatar.avatar_id,
                    age: ageTimestamp ? calculatePlayerAge(ageTimestamp) : 'N/A' // Calculate age in days
                };
            });

            // Wait for all promises to resolve
            const players = await Promise.all(playerPromises);

            players.forEach(player => {
                tableHtml += `
                    <tr>
                        <td>${player.name}</td>
                        <td>${player.id}</td>
                        <td>${player.age} days</td>
                    </tr>`;
            });

            tableHtml += `
                    </tbody>
                </table>`;

            playersContainer.innerHTML = tableHtml; // Update the container with the table
        }

        window.onload = function() {
            loadOnlinePlayers();
        };
    </script>

</body>
</html>
